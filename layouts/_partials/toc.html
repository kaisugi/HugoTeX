{{- $content := .Content -}}
{{- if in .RawContent "<!--more-->" -}}
  {{- $parts := split .RawContent "<!--more-->" -}}
  {{- if gt (len $parts) 1 -}}
    {{- $content = index $parts 1 | $.RenderString -}}
  {{- end -}}
{{- end -}}

{{ if and (gt .WordCount 400) (.Param "toc") }}
    {{- /* 正規表現でh[1-6]を探す */ -}}
    {{- $header := (findRE "<h2.*?>(?:.|\n)*?</h2>" $content) -}}
    {{- /* 最初に出現するh[1-6]を取得 */ -}}
    {{- $firstH := index $header 0 -}}

    {{- if ne $firstH nil -}}
        {{- /* ヘッダーの前にToCを結合した「新しいヘッダー」を作成 */ -}}
        {{- $newH := printf `%s%s` .TableOfContents $firstH -}}
        {{- /* 古いヘッダーを新しいヘッダーに置換して出力 */ -}}
        {{- replace $content $firstH $newH | safeHTML -}}
    {{- else -}}
        {{- /* そもそもヘッダーがない時は普通に出力 */ -}}
        {{- $content | safeHTML -}}
    {{- end -}}
{{ else }}
    {{ $content | safeHTML }}
{{ end }}